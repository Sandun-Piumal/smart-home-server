<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Database Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f8f9fa; color: #333; }
        .header { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: between; align-items: center; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.3s; }
        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-info { background: #17a2b8; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .database-viewer { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; margin-top: 1rem; font-family: 'Courier New', monospace; font-size: 14px; max-height: 400px; overflow-y: auto; }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #569cd6; }
        .tabs { display: flex; margin-bottom: 1rem; background: #f8f9fa; border-radius: 10px; padding: 5px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: transparent; cursor: pointer; border: none; border-radius: 8px; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .users-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .users-table th, .users-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        .users-table th { background: #f8f9fa; font-weight: bold; color: #555; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-primary { background: #cce7ff; color: #004085; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .github-info { background: #f6f8fa; border: 1px solid #e1e4e8; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öôÔ∏è Admin Panel - Database Viewer</h1>
        <div>
            <button class="btn" onclick="goToDashboard()">üè† Dashboard</button>
            <button class="btn btn-danger" onclick="logout()" style="margin-left: 10px;">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2 style="margin-bottom: 1.5rem;">üìä System Overview</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminUsers">0</div>
                    <div class="stat-label">Admin Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="regularUsers">0</div>
                    <div class="stat-label">Regular Users</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')">üë• User Management</button>
                <button class="tab" onclick="showTab('database')">üóÑÔ∏è Database View</button>
                <button class="tab" onclick="showTab('github')">üîó GitHub Data</button>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content active">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">User Management</h3>
                    <button class="btn btn-success" onclick="createTestUser()">+ Add Test User</button>
                </div>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Database Tab -->
            <div id="databaseTab" class="tab-content">
                <h3 style="margin-bottom: 1rem;">üóÑÔ∏è Live Database View</h3>
                <p style="margin-bottom: 1rem; color: #666;">This shows the actual data stored in your browser's localStorage:</p>
                <div class="database-viewer" id="databaseViewer">
                    <!-- Database content will be shown here -->
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 10px;">
                    <button class="btn btn-info" onclick="refreshDatabaseView()">üîÑ Refresh View</button>
                    <button class="btn" onclick="exportData()">üì• Export JSON</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>

            <!-- GitHub Tab -->
            <div id="githubTab" class="tab-content">
                <h3 style="margin-bottom: 1rem;">üîó GitHub Gist Data</h3>
                <div class="github-info">
                    <h4 style="margin-bottom: 0.5rem;">GitHub Gist Information</h4>
                    <p><strong>Gist URL:</strong> <span id="gistUrl">Loading...</span></p>
                    <p><strong>Status:</strong> <span id="gistStatus">Checking...</span></p>
                    <p><strong>Storage:</strong> Cloud (GitHub Gists)</p>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-info" onclick="viewGistOnGitHub()">üîç View on GitHub</button>
                    <button class="btn" onclick="syncWithGitHub()">üîÑ Sync with GitHub</button>
                </div>
                <div class="database-viewer" id="githubDataViewer" style="margin-top: 1rem;">
                    <!-- GitHub data will be shown here -->
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1rem;">üîß Quick Actions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <button class="btn btn-success" onclick="createTestUser()">üë§ Create Test User</button>
                <button class="btn btn-info" onclick="refreshAllData()">üîÑ Refresh All Data</button>
                <button class="btn" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear Data</button>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const GITHUB_TOKEN = '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';
        
        if (!currentUser) {
            alert('Access denied! Please login first.');
            window.location.href = 'index.html';
        } else if (currentUser.auth.role !== 'admin') {
            alert('Access denied! Admin privileges required.');
            window.location.href = 'dashboard.html';
        } else {
            loadAdminPanel();
            loadDatabaseView();
            loadGitHubData();
        }

        function loadAdminPanel() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            // Update stats
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.auth.status === 'active').length;
            document.getElementById('adminUsers').textContent = users.filter(u => u.auth.role === 'admin').length;
            document.getElementById('regularUsers').textContent = users.filter(u => u.auth.role === 'user').length;

            // Load users table
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.personal.fullName}</td>
                    <td>${user.personal.email}</td>
                    <td>${user.personal.phone}</td>
                    <td>
                        <span class="badge ${user.auth.role === 'admin' ? 'badge-primary' : 'badge-success'}">
                            ${user.auth.role}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${user.auth.status === 'active' ? 'badge-success' : 'badge-danger'}">
                            ${user.auth.status}
                        </span>
                    </td>
                    <td>${new Date(user.timestamps.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" onclick="toggleUserStatus('${user.id}')" style="padding: 5px 10px; font-size: 0.8rem;">
                            ${user.auth.status === 'active' ? 'Deactivate' : 'Activate'}
                        </button>
                        ${user.id !== currentUser.id ? `
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="padding: 5px 10px; font-size: 0.8rem;">Delete</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function loadDatabaseView() {
            const allData = {
                users: JSON.parse(localStorage.getItem('users')) || [],
                currentUser: JSON.parse(localStorage.getItem('currentUser')) || null,
                githubToken: localStorage.getItem('githubToken') || 'Not set'
            };

            const formattedJSON = syntaxHighlight(JSON.stringify(allData, null, 2));
            document.getElementById('databaseViewer').innerHTML = formattedJSON;
        }

        async function loadGitHubData() {
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const gists = await response.json();
                    const authGist = gists.find(gist => gist.description === 'AuthProUserData');
                    
                    if (authGist) {
                        document.getElementById('gistUrl').innerHTML = `<a href="${authGist.html_url}" target="_blank">${authGist.html_url}</a>`;
                        document.getElementById('gistStatus').innerHTML = '<span style="color: green;">‚úÖ Connected</span>';
                        
                        // Load gist content
                        const gistResponse = await fetch(authGist.url, {
                            headers: {
                                'Authorization': `token ${GITHUB_TOKEN}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (gistResponse.ok) {
                            const gistData = await gistResponse.json();
                            const content = gistData.files['auth-data.json'].content;
                            const formattedContent = syntaxHighlight(content);
                            document.getElementById('githubDataViewer').innerHTML = formattedContent;
                        }
                    } else {
                        document.getElementById('gistStatus').innerHTML = '<span style="color: orange;">‚ö†Ô∏è No Auth Gist Found</span>';
                    }
                } else {
                    document.getElementById('gistStatus').innerHTML = '<span style="color: red;">‚ùå Connection Failed</span>';
                }
            } catch (error) {
                document.getElementById('gistStatus').innerHTML = '<span style="color: red;">‚ùå Error: ' + error.message + '</span>';
            }
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab:nth-child(${tabName === 'users' ? 1 : tabName === 'database' ? 2 : 3})`).classList.add('active');
            
            // Refresh data if needed
            if (tabName === 'database') {
                loadDatabaseView();
            } else if (tabName === 'github') {
                loadGitHubData();
            }
        }

        function toggleUserStatus(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users.find(u => u.id === userId);
            
            if (user) {
                user.auth.status = user.auth.status === 'active' ? 'inactive' : 'active';
                user.timestamps.updatedAt = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
                alert(`User ${user.personal.fullName} ${user.auth.status} successfully!`);
                loadAdminPanel();
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                const users = JSON.parse(localStorage.getItem('users'));
                const updatedUsers = users.filter(u => u.id !== userId);
                localStorage.setItem('users', JSON.stringify(updatedUsers));
                alert('User deleted successfully!');
                loadAdminPanel();
                loadDatabaseView();
            }
        }

        function createTestUser() {
            const users = JSON.parse(localStorage.getItem('users'));
            const testUser = {
                id: 'test_' + Date.now(),
                personal: {
                    fullName: 'Test User ' + (users.length + 1),
                    phone: '071234567' + users.length,
                    birthday: '1995-01-01',
                    age: 28,
                    email: 'testuser' + (users.length + 1) + '@example.com'
                },
                auth: {
                    password: btoa('test123'),
                    role: 'user',
                    status: 'active'
                },
                timestamps: {
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    updatedAt: new Date().toISOString()
                }
            };

            users.push(testUser);
            localStorage.setItem('users', JSON.stringify(users));
            alert('Test user created!\nEmail: ' + testUser.personal.email + '\nPassword: test123');
            loadAdminPanel();
            loadDatabaseView();
        }

        function refreshDatabaseView() {
            loadDatabaseView();
            alert('Database view refreshed!');
        }

        function refreshAllData() {
            loadAdminPanel();
            loadDatabaseView();
            loadGitHubData();
            alert('All data refreshed!');
        }

        function exportData() {
            const data = {
                users: JSON.parse(localStorage.getItem('users')) || [],
                exportDate: new Date().toISOString(),
                totalUsers: (JSON.parse(localStorage.getItem('users')) || []).length
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'user-data-export.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL users except your current admin account! Continue?')) {
                const users = [{
                    id: currentUser.id,
                    personal: currentUser.personal,
                    auth: currentUser.auth,
                    timestamps: {
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                }];
                
                localStorage.setItem('users', JSON.stringify(users));
                alert('All data cleared! Only your admin account remains.');
                loadAdminPanel();
                loadDatabaseView();
            }
        }

        function viewGistOnGitHub() {
            window.open('https://gist.github.com', '_blank');
        }

        async function syncWithGitHub() {
            alert('Syncing with GitHub... (This would sync local data with GitHub Gists in a full implementation)');
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
